<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <style>
      hr {
        margin-top: 30px;
      }
    </style>
    <script type="module">
      import { auth } from "/api/request.js";
      import * as authApi from "/api/auth.js";
      import * as usersApi from "/api/users.js";
      import * as postsApi from "/api/posts.js";
      import * as galleriesApi from "/api/galleries.js";

      import * as imageUtils from "/utils/imageUtils.js";

      const getProfile = async () => {
        userOutput.innerHTML = "Loading...";
        const data = await authApi.getProfile();

        if (!data?.success) return (userOutput.innerHTML = "");
        console.log(data, "data-user");
        getGallery();

        userOutput.innerHTML = `
           <img src="${data.data.avatar || "/assets/images/avatar-placeholder.png"}" style='width:100px;height:100px;object-fit:cover' />

            <ul>
                <li>
                    <strong>Name: </strong> ${data.data.name}
                </li>
                <li>
                    <strong>Age: </strong> ${data.data.age}
                </li>
                <li>
                    <strong>Email: </strong> ${data.data.email}
                </li>
                <li>
                    <strong>Id: </strong> ${data.data._id}
                </li>
                  <li>
                    <strong>Roles: </strong>
                    <ul>
                     ${data.data.roles.map((role) => `<li>${role}</li>`).join("")}
                    </ul>
                </li>
           </ul>
        `;

        document
          .querySelector("#update-user-form")
          .querySelectorAll("input")
          .forEach((input) => {
            if (input.name == "name") input.value = data.data.name;
            if (input.name == "age") input.value = data.data.age;
          });
      };

      getProfile();

      const getGallery = async () => {
        const data = await galleriesApi.getGalleries({ userId: auth.currentUser._id });
        document.querySelector(".gallery-link").href = `/dashboard/galleries/${auth.currentUser._id}`;

        if (!data?.success) return;
        console.log(data, "data-gallery");

        if(!data.data.length) return  
        data.data[0].images.forEach((image) => {
          document.querySelector(`.gallery-image-${image.index + 1}`).src = image.url;
        });
        
      };

      const handleDeleteProfile = async (id) => {
        const data = await usersApi.deleteUser({ id: auth.currentUser._id });
        if (!data?.success) return;
        console.log(data, "data-deleted-user");
      };

      const handleUpdateProfile = async (e) => {
        e.preventDefault();
        const { name, age, avatar } = e.target;
        const body = {};
        if (name.value !== auth.currentUser.name) body.name = name.value;
        if (age.value !== auth.currentUser.age) body.age = age.value;
        if (avatar.files && avatar.files.length > 0) {
          // const compressedBlob = await compressImage(cover.files[0], 300);
          const imageBase64 = await imageUtils.convertToBase64(avatar.files[0]);
          if (imageBase64) body.avatar = imageBase64;
          // e.target.value = "";
        }

        userOutput.innerHTML = "Loading...";
        const data = await usersApi.updateUser({ id: auth.currentUser._id, body });

        getProfile();

        if (!data.success) return;
        alert(data.message || "user updated");
        console.log(data, "data-updated-user");
      };

      const handleCreatePost = async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);

        const data = await postsApi.createPost({ body: formData });
        if (!data.success) return;

        alert(data.message || "post created");
        console.log(data, "data-created-post");
      };

      document.querySelector("button#get-profile-btn").addEventListener("click", getProfile);
      document.querySelector("button#delete-user-btn").addEventListener("click", handleDeleteProfile);
      document.querySelector("#update-user-form").addEventListener("submit", handleUpdateProfile);
      document.querySelector("#create-post-form").addEventListener("submit", handleCreatePost);
    </script>
  </head>
  <body>
    <a href="/dashboard">Dashboard</a>

    <hr />
    <h1>My Profile</h1>
    <hr />

    <div id="userOutput">Empty</div>

    <div class="gallery" style="border: 1px solid lightgray; padding: 3px; display: inline-block">
      <img
        src="/assets/images/post-placeholder.jpg"
        class="gallery-image gallery-image-1"
        style="width: 50px; height: 50px; object-fit: cover"
      />
      <img
        src="/assets/images/post-placeholder.jpg"
        class="gallery-image gallery-image-2"
        style="width: 50px; height: 50px; object-fit: cover"
      />
      <img
        src="/assets/images/post-placeholder.jpg"
        class="gallery-image gallery-image-3"
        style="width: 50px; height: 50px; object-fit: cover"
      />
      <img
        src="/assets/images/post-placeholder.jpg"
        class="gallery-image gallery-image-4"
        style="width: 50px; height: 50px; object-fit: cover"
      />
      <button>
        <a class="gallery-link" href="/">update</a>
      </button>
    </div>
    <hr />

    <h2>Update Profile</h2>
    <form action="" id="update-user-form">
      <input type="text" name="name" placeholder="name" />
      <input type="text" name="age" placeholder="age" />
      <input type="file" name="avatar" accept="image/*" />
      <button>Update</button>
    </form>
    <br />

    <hr />
    <h2>Create Post</h2>
    <form action="" id="create-post-form">
      <input type="text" name="name" placeholder="name" />
      <input type="text" name="description" placeholder="description" />
      <input type="date" name="date" placeholder="date" />
      <input type="file" name="image" accept="image/*" />
      <button>Create</button>
    </form>
    <br />

    <hr />
    <button class="" id="delete-user-btn">Delete user</button>
    <button class="" id="get-profile-btn">Get profile</button>
    <br>
    <br>
    <br>
    <br>
  </body>
</html>
